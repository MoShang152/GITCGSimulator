## 面向状态

将游戏状态储存在一个独立单元之中, 所有逻辑单元并不储存任何状态数据, 仅根据状态工作.

> 该设计思路和以往的最大区别在于, "状态和逻辑分离", 所有状态数据集中在同一个地方, 而不是分散在各个类的私有变量中.

### 流程

1. 复制当前游戏状态
2. 根据玩家输入和游戏状态修改状态
3. 保存新状态

### 状态类约定

状态类应该提供以下接口:

```
GameState:
    __init__():初始化游戏状态.
    clone():返回状态的深拷贝.
    get(location):根据位置标记返回特定数据.
    getX():返回特定区域的所有数据.
    numpy():返回状态的numpy格式. 注意由于维度等, numpy()和clone()不一定能完全互相翻译. clone()保证复制游戏内部所有组件的状态数据, 但是numpy()可能囿于设计缺陷不能完全表征所有状态.
```

状态类是一个read-only类. 所有对于状态的修改都交予外部类.

### 状态类实现

这里要解决分区定义问题和numpy格式. 格式最好能向前兼容, 以免mhy更新



## 消息处理

不管是什么架构, 七圣的消息(事件,效应等等)都遵循"就近原则". 即最近的事件最先被处理, 它看上去像一个栈结构, 但是如果一个事件包含了多个效应, 却又存在固定顺序. 所以总的来说是**宏观栈微观队列**的数据结构.

### 结算顺序

装备区, 角色状态区, 状态区, 召唤区, 支援区.

### 刷新逻辑

如果某个token场上已有, 则不会改变其位置而仅刷新其状态.

### 伤害流程

七圣的伤害状态机如下:

1. 确定伤害类型(附魔检查在这一阶段)
2. 进行元素反应. 此处发射反应消息.
3. 确定伤害数值(增伤阶段). 
4. 施加伤害(莫娜泡影作用阶段). 
5. 进行减伤. 3,4,5可能出现状态耗尽消息.
6. 造成伤害(此处是最终伤害). 此处发射伤害消息(可能出现死亡消息).

伤害来源:

角色,召唤物,状态.

所有元素反应造成的伤害都视触发元素反应的单位为来源.

#### 位置

精确描述七圣里的某个token的位置大致需要5个变量, 其中常用的是3个, 最后两个用于定位角色状态或者装备.

player id, area id, intra-area index, subarea id, offset

因为对于后者而言, 先要定位角色, 才能定位角色状态/装备.

#### 伤害类



### 预计算

例如, 在有须弥城的情况下, 刻晴雷楔的费用该如何计算?

注意雷楔属于一张手牌, 但是它却可以享受到针对技能的减费(须弥城). 

由于七圣定义很混乱, 这里提出一种基于约定的减费/增费方案, 即每张卡标明自己能够享受的减费范围. 

技能使用等不需要标记, 因为它定义很清楚, 就是使用技能.

### 元素反应